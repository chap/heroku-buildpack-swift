#!/usr/bin/env bash

# bin/compile <build-dir> <cache-dir> <env-dir>

# fail fast
set -e

BP_DIR=$(cd $(dirname $0)/..; pwd) # absolute path
. $BP_DIR/lib/common.sh

BUILD_DIR=$1
CACHE_DIR=$2/swift

mkdir -p $CACHE_DIR

SWIFT_VERSION="2.2-SNAPSHOT-2015-12-01-b"
SWIFT_PLATFORM="ubuntu14.04"

cat<<"EOF"
      `.........`                                               
     ;;;;;;;;;;;;;                                              
    ;;;;;;;;;;;;;;;                                             
    ;;;;;;;;;.;;;;;                                +##          
    ;;,;.;;;;..;;;;`     `#,.+`              ;#   :`            
    ;;; ;`;;;; :;;;`     #                    `   #    :        
    ;;;; ; ;;;  ;;;`     ,                        #    #        
    ;;;;; , :;  ;;;`     +      +    '     +  ;  +######++      
    ;;;;;;   `  ;;;`     #`     #    #'    ;  '   #    #        
    ;;;;;;;     ;;;`      '#`   '    ,#   +   '   #    #        
    ;; ;;;;:    :;;`        :#   ;  # ;   #   '   #    #        
    ;;;          ;;`          #  #  #  '  ;   '   #    #        
    ;;;;.     `: ;;`          #  # `.  # ;    '   #    #        
    ;;;;;;;;;;;;;;;           #  ``#   ; #    '   #    #        
    ;;;;;;;;;;;;;;;           +   ##    :;    '   #    #        
     ;;;;;;;;;;;;;      +#:,+#    #`    #     '   #    #;:      
EOF

cd $BUILD_DIR
mkdir -p .heroku/swift
mkdir -p /app/.heroku
ln -s $BUILD_DIR/.heroku/swift /app/.heroku/swift

install_swift $SWIFT_VERSION $SWIFT_PLATFORM ${BUILD_DIR}/.heroku/swift 2>&1 | sed -u 's/^/       /'

mkdir -p $BUILD_DIR/.profile.d
cat > $BUILD_DIR/.profile.d/swift.sh <<EOF
export PATH="/app/.heroku/swift/swift-$SWIFT_VERSION-$SWIFT_PLATFORM/usr/bin":$PATH
EOF

